{% extends 'ActualSkillSiteBundle::base.html.twig' %}

{% block javascripts %}
    {{ parent() }}

    {% javascripts
        '@ActualSkillCoreBundle/Resources/public/js/jquery.autogrowtextarea.js'
        '@ActualSkillCoreBundle/Resources/public/js/highcharts.js'
    %}
    <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}


{% endblock %}

{% block header %}
<script language="javascript">

    var chart;
    $(document).ready(function() {

        $('.rating-box').click(function() {
            $(this).find(".rating-toggle ").toggle();

        });

        $('.nav-pills a:first').tab('show')

        $(".autogrow").autogrow({

        });

        $('#toggle_ratings_button').click(function(){
            $(this).toggleClass("active");
            $('#ratings').slideToggle("fast");
        });

        $('#likebutton').click(function() {

            console.log("like button!");

            $.post("/like/{{player.slug}}", function(data) {
               // first success
            })
            .success(function(data) {
                data = jQuery.parseJSON(data);

                if(data.like){
                    $('#likebutton a').html("unlike");
                    //$.jGrowl("You like {{player.name}}", { life: 1000 });
                }else{
                    $('#likebutton a').html("like");
                }
            })
            .error(function() {})
            .complete(function() {});

            return false;
        });

        $('.btncomment').click(function() {
            var textarea = $(this).siblings('textarea');
            var comment = textarea.val();

            // If comment is empty. Abandon!
            if(jQuery.trim( comment ) == ""){
                return;
            }

            var dataString = 'comment='+comment;
            $.post("/comment/create/{{player.slug}}", dataString, function(data) {
               // first success
            })
            .success(function(data) {
                data = jQuery.parseJSON(data);
                console.log(data);
                $("#comments").prepend(data.comment);
                textarea.val("");
                textarea.blur();
            })
            .error(function() {})
            .complete(function() {});

            return false;
        });

        $('.rateclick').bind('click', function() {

            var attribute = this.id.split("_")[0];
            var id = this.id.split("_")[1];
            var value = $(this).html();
            var el = $(this);
            
            var content = el.html();
            el.html("&nbsp;");
            el.spin("tiny");
            
            $(this).parent().parent().find('.rateclick').removeClass('active');

            $.post("/rate/{{player.slug}}/"+attribute+"/"+value, function(data) {
               // first success
                data = jQuery.parseJSON(data);
            })
            .success(function(data) {
                data = jQuery.parseJSON(data);
                
                el.spin(false);
                el.html(content);
                
                var offset = el.offset();
                var feedback = $(document.createElement('span'));
                feedback.css("display", "none");
                feedback.html("Rating saved!");
                $('body').append(feedback);
                
                feedback.css("top", offset.top-feedback.height());
                feedback.css("left", (offset.left+el.width()/2)-(feedback.width())/2);
                feedback.css("position", "absolute");
                
                el.addClass('active');
                feedback.show();
                feedback.animate(
                {
                    top: '-=20', 
                    opacity:0
                },
                {
                    duration: 1000, // how fast we are animating
                    easing: 'easeOutQuad',
                    complete: function() {
                        $(this).remove();
                    }
                });
            })
            .error(function() {})
            .complete(function() {

            });

            return false;
        });

        var data = [];
        var categories = [];

        {% for statsheet in player.statsheets %}
            data.push({{statsheet.attributeRatingWeighted}})
            categories.push("{{statsheet.createdAt|date("d. M", "Europe/Copenhagen")}}");
        {% endfor %}

        chart1 = new Highcharts.Chart({
            chart: {
                renderTo: 'chart',
                type: 'line',
                marginTop: 0,
                marginBottom: 18,
                spacingBottom: 5,
                spacingTop: 0,
                spacingLeft: 0,
                spacingRight: 0,
            },
            legend: {
                align: 'center',
                verticalAlign: 'bottom',
                y: 0,
                floating: false,
                borderWidth: 0
            },
            title: {
                text: ''
            },
            credits: {
                enabled: false
            },
            plotOptions: {
                series: {
                    color: '#468847'
                }
            },
            xAxis: {
                tickInterval: categories.length-1,
                categories: categories
            },
            yAxis: {
                max: 10,
                min: 0,
                tickInterval: 2,
                gridLineWidth: 1,
                gridLineColor: "#75CC55",
                gridLineDashStyle: "dot",
                title: {
                    text: ''
                },
                labels:
                {
                  enabled: false
                },
                plotBands: [{
                    from: 0,
                    to: 2,
                    //color: 'rgba(68, 170, 213, 0.1)',
                    color: 'rgba(255, 255, 255, 1)',
                    label: {
                        text: 'Amateur Class',
                        style: {
                            //color: 'rgba(68, 170, 213, 0.3)',
                            color: 'rgba(70, 136, 71, 0.5)',
                            fontWeight: 'bold',
                            fontSize: "8px"
                        }
                    },
                },{
                    from: 2,
                    to: 4,
                    color: 'rgba(255, 255, 255, 1)',
                    label: {
                        text: 'Local Class',
                        style: {
                            color: 'rgba(70, 136, 71, 0.5)',
                            fontWeight: 'bold',
                            fontSize: "8px"
                        }
                    }
                },{
                    from: 4,
                    to: 6,
                    color: 'rgba(255, 255, 255, 1)',
                    label: {
                        text: 'National Class',
                        style: {
                            color: 'rgba(70, 136, 71, 0.5)',
                            fontWeight: 'bold',
                            fontSize: "8px"
                        }
                    }
                },{
                    from: 6,
                    to: 8,
                    color: 'rgba(255, 255, 255, 1)',
                    label: {
                        text: 'Regional Class',
                        style: {
                            color: 'rgba(70, 136, 71, 0.5)',
                            fontWeight: 'bold',
                            fontSize: "8px"
                        }
                    }
                },{
                    from: 8,
                    to: 10,
                    color: 'rgba(255, 255, 255, 1)',
                    label: {
                        text: 'World Class',
                        style: {
                            color: 'rgba(70, 136, 71, 0.5)',
                            fontWeight: 'bold',
                            fontSize: "8px"
                        }
                    }
                }]
            },
            tooltip: {
                shared: true
            },
            series: [{
                name: 'Skills',
                type: 'spline',
                data: data
            }]
        });

    });

</script>
{% endblock %}

{% block body %}

<div class="row">


    <div class="span8">

        <div class="factsheet">
            <h1>{{ player.fullname }} <small><span id="likebutton"><a href="#">{% if likes == true %} Unlike {% else %} Like {% endif %}</a></span></small></h1>

            <div class="factbox">
                <table>
                    <tr>
                        <th>Height</th>
                        <td>{{player.height}} cm</td>
                        <th>Club</th>
                        <td><a href="{{ path('site_club_show', { 'id': player.club.slug }) }}">{{player.club}}</a></td>
                    </tr>

                    <tr>
                        <th>Weight</th>
                        <td>{{player.weight}} kg</td>
                        <th>Nationality</th>
                        <td><img src="{{ asset('bundles/actualskillsite/img/flags/') }}{{player.country.iso2|lower}}.png"/> {{player.country}}</td>
                    </tr>
                    <tr>
                        <th>Age</th>
                        <td>{{player.age}}</td>
                        <th>Fans</th>
                        <td>{{player.likes|length}} {{ player.likes|length == 1 ? 'fan' : 'fans' }}</td>
                    </tr>
                    <tr>
                        <th>Birthday</th>
                        <td>{{player.birthday|date("j. F Y")}}</td>
                        <th>Average skill</th>
                        <td>{{ player.ratingAverage }}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="row">
            <div class="span2">
                <h4>Rate player</h4>
                <ul class="nav nav-pills nav-stacked">
                    {% for category in categories %}
                        <li><a href="#{{category.slug}}" data-toggle="pill">{{category.name}}</a></li>
                    {% endfor %}
                    </li>
                </ul>
            </div>
            <div class="span6">
                <div class="pill-content">
                    {% for category in categories %}

                        <div class="pill-pane rating-pane" id="{{category.slug}}">
                            {% for attribute in category.attributes %}

                                {% if attribute.averageRating >= 7 %}
                                {% set label = 'high' %}
                                {% elseif attribute.averageRating < 4 %}
                                {% set label = 'low' %}
                                {% else %}
                                {% set label = 'medium' %}
                                {% endif %}

                                <div rel="tooltip" class="rating-box">
                                    <div class="top-container">
                                        <div class="text-box">
                                            <!--<span class="label {{label}} label-average"> {{attribute.averageRating}}</span>-->
                                            <span class="attribute-name">{{ attribute.name }}</span>
                                        </div>
                                        <div class="rating-button-row">
                                            {% for i in 1..10 %}
                                                {% if i >= 7 %}
                                                {% set label = 'high' %}
                                                {% elseif i < 4 %}
                                                {% set label = 'low' %}
                                                {% else %}
                                                {% set label = 'medium' %}
                                                {% endif %}                                        

                                                <div class="rating-button-container condensed">

                                                    {% if attribute.userRating == i %}
                                                    <div id="{{attribute.slug}}_{{attribute.id}}" class="{{label}} active rateclick rating-button">{{i}}</div>
                                                    {% else %}
                                                    <div id="{{attribute.slug}}_{{attribute.id}}" class="{{label}} rateclick rating-button">{{i}}</div>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>                                    
                                    </div>
                                    <span class="attribute-description">{{ attribute.description}}</span>                                
                                </div>                    
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>        
            </div>                
        </div>
        

        <div class="row">
            <div class="span4">
                <h5>Strengths</h5>
                <table class="table table-condensed">
                    {% for attribute in topattributes %}
                    <tr>
                        {% if attribute.averageRating >= 7 %}
                        {% set label = 'high' %}
                        {% elseif attribute.averageRating < 4 %}
                        {% set label = 'low' %}
                        {% else %}
                        {% set label = 'medium' %}
                        {% endif %}

                        <td><span class="label {{label}} label-average"> {{attribute.averageRating}}</span> {{ attribute.name }} <span style="color: #ddd; font-size: 11px; vertical-align: top">{{attribute.categoryName}}</span></td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
            <div class="span4">
                <h5>Weaknesses</h5>
                <table class="table table-condensed">
                    {% for attribute in bottomattributes %}
                    <tr>
                        {% if attribute.averageRating >= 7 %}
                        {% set label = 'high' %}
                        {% elseif attribute.averageRating < 4 %}
                        {% set label = 'low' %}
                        {% else %}
                        {% set label = 'medium' %}
                        {% endif %}

                            <td><span class="label {{label}} label-average"> {{attribute.averageRating}}</span> {{ attribute.name }} <span style="color: #ddd; font-size: 11px; vertical-align: top">{{attribute.categoryName}}</span></td>
                        <td></td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>        
        
        <hr>

        <h3>Comments</h3>
        <div class="fb-comments" data-href="{{facebook_comments_base_href}}{{ path('player_show', { 'id': player.slug }) }}" data-num-posts="2" data-width="470"></div>

        <!--
        <div class="row">
            <div class="span8">
                <h2>Comments</h2>
                <textarea class="xxlarge span8 autogrow" name="comment" rows="1"></textarea>
                <input type="submit" class="btn primary btncomment" value="Submit"/>
                <hr>

                <div id="comments">
                {% for comment in player.comments %}
                    <div>
                        <span><strong>{{comment.user.fullname}}</strong></span><br/>
                        <span>{{comment.comment}}</span><br/>
                        <span><small>{{comment.createdAt|date("m/d/Y")}}</small></span>
                    </div>
                    <hr>
                {% endfor %}
                </div>
            </div>
        </div>
        -->
    </div>


    <div class="span4">
        <!--
        <div class="five columns statcontainer">
            <div class="stats">
                <span class="statbox">
                    ActualSkill
                    <span class="number">{{ player.ratingAverage }}</span>
                </span>
                <span class="statbox">
                    Skills
                    <span class="number">{{ player.ratingAverage }}</span>
                </span>
                <span class="statbox">
                    Form
                    <span class="number">0</span>
                </span>
            </div>
        </div>
        -->

        <!--
        <ul class="stats-tabs">
            <li>{{ player.ratingAverage }} <span>ActualSkill</span></li>
            <li>{{player.likes|length}} <span>{{ player.likes|length == 1 ? 'fan' : 'fans' }}</span></li>
            <li>{{player.ratings|length}} <span>{{ player.ratings|length == 1 ? 'rating' : 'ratings' }}</span></li>
            <li>{{player.comments|length}} <span>{{ player.comments|length == 1 ? 'comment' : 'comments' }}</span></li>
        </ul>
	-->

        <div class="bannerad column top">
            <img src="http://lorempixel.com/300/250/technics/" />
        </div>

        <h4>Player Development</h4>
        <div id="chart" style="height:150px; width: 100%; margin-bottom: 15px;"></div>

        <!--
        <h4>Rate player</h4>
        <ul class="nav nav-pills nav-stacked">
            {% for category in categories %}
                <li><a href="#{{category.slug}}" data-toggle="pill">{{category.name}}</a></li>
            {% endfor %}
            </li>
        </ul>

        <div class="pill-content">
            {% for category in categories %}

                <div class="pill-pane rating-pane" id="{{category.slug}}">
                    <h4>{{category.name}}</h4>
                    {% for attribute in category.attributes %}

                        {% if attribute.averageRating >= 7 %}
                        {% set label = 'label-success' %}
                        {% set progress = 'progress-high' %}
                        {% elseif attribute.averageRating < 4 %}
                        {% set label = 'label-error' %}
                        {% set progress = 'progress-low' %}
                        {% else %}
                        {% set label = 'label-warning' %}
                        {% set progress = 'progress-medium' %}
                        {% endif %}


                        <div rel="tooltip" class="rating-box">
                            <div class="attribute-name">
                                {{ attribute.name }}
                            </div>
                            <div class="attribute-rating">
                                {{attribute.averageRating}}
                            </div>
                            <div class="attribute-progress">
                                <div class="progress {{progress}}">
                                    <div class="text">{{attribute.averageRating}}</div>
                                    <div class="bar" style="width:{{(attribute.averageRating/10)*100}}%;"></div>
                                </div>
                            </div>

                            <div class="rating-toggle hide">
                                <div class="rating-button-row">
                                    {% for i in 1..10 %}
                                        <div class="rating-button-container condensed">

                                            {% if attribute.userRating == i %}
                                            <div id="{{attribute.slug}}_{{attribute.id}}" class="active rateclick rating-button">{{i}}</div>
                                            {% else %}
                                            <div id="{{attribute.slug}}_{{attribute.id}}" class="rateclick rating-button">{{i}}</div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="attribute-description">{{ attribute.description}}</div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
        -->

        <h4>Top 10 team members</h4>
        <table class="table table-condensed">
            {% for teammember in teammembers %}
                {% if loop.index0 < 10 %}

                {% if teammember.ratingAverage >= 7 %}
                {% set label = 'high' %}
                {% elseif teammember.ratingAverage < 4 %}
                {% set label = 'low' %}
                {% else %}
                {% set label = 'medium' %}
                {% endif %}                
            <tr>
                <td><span class="label {{label}} label-average"> {{teammember.ratingAverage}}</span> <a href="{{ path('player_show', { 'id': teammember.slug }) }}">{{ teammember.fullname }}</a> | {{teammember.likes|length}} {{ teammember.likes|length == 1 ? 'fan' : 'fans' }}</td>
            </tr>
                {% endif %}
            {% endfor %}
            <tr>
                <td><a href="{{ path('site_club_show', { 'id': player.club.slug }) }}">See all team members</a></td>
            </tr>
        </table>
    </div>
</div>

<!--
<div class="row">
    <div class="span12">
        {% for position in positions %}

            {% if position.category == "defence" %}
            <span style="color:red">{{position.name}} ({{position.shortname}})</span>
            {% elseif position.category == "midfield" %}
            <span style="color:blue">{{position.name}} ({{position.shortname}})</span>
            {% elseif position.category == "attack" %}
            <span style="color:green">{{position.name}} ({{position.shortname}})</span>
            {% endif %}
            <br />
        {% endfor %}
    </div>
</div>
-->

<div id="myModal" class="modal hide" style="display: none; ">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">×</a>
        <h3>Modal Heading</h3>
    </div>
    <div class="modal-body">

        <div class="rating-button-row">
        {% for i in 1..10 %}
            <div class="rating-button-container">
                <div class="rating-button">
                {{i}}
                </div>
            </div>
        {% endfor %}
        </div>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn btn-primary">Save changes</a>
        <a href="#" class="btn" data-dismiss="modal">Close</a>
    </div>
</div>
{% endblock %}